---
- name: Extra locale config for ru_RU.utf8

  vars:
    locale: ru_RU.utf8
    # This keymap must have builtin Ctrl-Shift key shortcut for switching the
    # keyboard layout.
    keymap: ru
    keymap_dir: /usr/share/kbd/keymaps/i386/qwerty
    keymap_ext: map.gz

  block:

  - name: ∎ locale '{{ locale }}'
    shell:
      cmd: "locale -a"
    register: locales
    changed_when: false
  - fail:
    when: locale not in locales.stdout_lines

  - name: ∎ keymap '{{ keymap }}'
    stat:
      path: "{{ keymap_dir }}/{{ keymap }}.{{ keymap_ext }}"
    register: keymap_file
  - fail:
    when: not keymap_file.stat.exists

  - name: Set '{{keymap }}' keymap for console
    lineinfile:
      path: /etc/vconsole.conf
      regexp: "^\\s*KEYMAP="
      line: "KEYMAP={{ keymap }}"
      validate: >
        '{{ uws }}/validator/conf-uniq.sh'
        'KEYMAP={{ keymap }}'
        '%s'
    become: true

  - name: Reload console config
    shell:
      cmd: "systemctl restart systemd-vconsole-setup.service"
    become: true
    changed_when: false
