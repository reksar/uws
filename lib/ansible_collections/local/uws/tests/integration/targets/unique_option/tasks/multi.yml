- set_fact:
    tests: "{{ playbook_dir | regex_search('.*?/tests') }}"

- set_fact:
    module_tests: "{{ tests }}/integration/targets/unique_option"

- set_fact:
    source_config: "{{ module_tests }}/res/multi.conf"
    test_config: "{{ playbook_dir }}/multi.conf"
    option: "alias ll='ls -l --color=auto'"

- name: "Copy the test config to modify it further"
  copy:
    src: "{{ source_config }}"
    dest: "{{ test_config }}"

- name: "Read original `ll` aliases"
  shell:
    cmd: "grep 'alias ll=' {{ test_config }}"
  register: ll_count
  failed_when: ll_count.stdout_lines | count <= 1
  changed_when: false

- name: "Add the new `ll` alias"
  local.uws.unique_option:
    file: "{{ test_config }}"
    line: "{{ option }}"

- name: "Read new `ll` aliases"
  shell:
    cmd: "grep 'alias ll=' {{ test_config }}"
  register: ll_count
  failed_when: ll_count.stdout_lines | count != 1
  changed_when: false

- name: "Test the option is set correctly"
  assert:
    that:
      - "ll_count.stdout == option"
