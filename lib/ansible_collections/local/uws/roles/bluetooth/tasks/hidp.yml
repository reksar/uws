# BlueZ >= 5.70 automatically enables the UserspaceHID and does not supports
# legacy HID devices. Disabling the UserspaceHID allows to support HID and HOG
# devices, but requires the HIDP kernel module. HIDP module for Linux kernel is
# deprecated and has some security issues.

- set_fact:
    # Expected:
    # * persist
    # * true
    # * false
    userspace_hid: >-
      {{
        lookup('file', 'input.conf')
        | regex_search(
            '^\s*UserspaceHID\s*=\s*(\w+)',
            '\1',
            multiline=True,
            ignorecase=True)
        | first
      }}

- name: "Fail if no Bluetooth HIDP kernel module"
  shell: "modinfo hidp"
  changed_when: false
  when: userspace_hid is equalto(false)
