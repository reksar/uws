# NOTE: Expected Hyprland to be running.

- include_vars: "waybar.yml"

- name: "/!/ waybar package"
  package:
    name: "waybar"
  become: true
  register: waybar_status

- name: "Update waybar package deps"
  when: waybar_status.changed
  shell: "pacman --sync --refresh --noconfirm gcc gcc-libs"
  become: true

- name: "/?/ temperature CLI"
  stat:
    path: "/usr/local/bin/temperature"
  register: temperature_cli

- name: "/>/ temperature util"
  when: temperature_cli.stat.exists
  copy:
    src: "waybar/temperature.sh"
    dest: "{{ waybar.config_dir }}/util/"
    mode: "u=rwx,g=rx,o=rx"

- name: "/>/ waybar config"
  vars:
    temperature: >-
      {{
        temperature_cli.stat.exists
        | ternary('custom/temperature', 'temperature')
      }}
    temperature_module: >-
      {{
        lookup(
          'template',
          'waybar/module/'
            + temperature_cli.stat.exists
              | ternary('temperature', 'temperature_default')
            + '.jsonc',
          variable_start_string="<<",
          variable_end_string=">>",
        )
      }}
  loop:
    - "{{ waybar.config_name }}"
    - "{{ waybar.style_name }}"
  template:
    src: "waybar/hyprland.{{ item }}"
    dest: "{{ waybar.config_dir }}/{{ item }}"
    variable_start_string: "<<"
    variable_end_string: ">>"
  register: config_status

- debug:
    msg: "waybar status changed"
  changed_when: waybar_status.changed or config_status.changed
  notify: "Restart waybar"

- name: "/*/ Add waybar to Hyprland"
  vars:
    cfg: "{{ waybar.config_dir }}/{{ waybar.config_name }}"
    css: "{{ waybar.config_dir }}/{{ waybar.style_name}}"
  lineinfile:
    path: "{{ XDG_CONFIG_HOME }}/hypr/hyprland.conf"
    regexp: "exec-once\\s*=\\s*waybar"
    line: "exec-once = waybar -c '{{ cfg }}' -s '{{ css }}'"
