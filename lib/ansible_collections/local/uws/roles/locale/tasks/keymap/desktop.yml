# Set vars to be used by another roles for keyboard setup.


- set_fact:
    # The `keyboard.layouts.list`. Or generate list using the `locale.list`:
    #   * take '<xx>_<YY>' or '<xx>_<YY>.<CP>'
    #   * map -> '<xx>' or '<xx>.<CP>'
    #   * map '<xx>' -> '<xx>.utf8' so all values became '<xx>.<CP>'
    #   * replace 'en' to 'us'
    keyboard_layouts: >-
      {{
        settings.keyboard.layout.list or (
          settings.locale.list
          | map('regex_search', '^\w+_\w+(\..*){0,1}')
          | reject('==', None)
          | map('regex_replace', '_\w+', '')
          | map('regex_replace', '^(\w+)$', '\1.utf8')
          | map('lower')
          | map('regex_replace', '^en\.', 'us.')
          | unique
        )
      }}

- set_fact:
    # For example, 'us,ru'.
    kb_layout: >-
      {{
        keyboard_layouts | map('regex_replace', '\..*', '') | join(',')
      }}

- set_fact:
    # For example, if `settings.keyboard.layout.switch` == 'Alt+Shift', then
    # `switch` == 'alt_shift'.
    switch: >-
      {{
        settings.keyboard.layout.switch | lower | regex_replace('\+', '_')
      }}

- set_fact:
    kb_options: "ctrl:nocaps,grp:{{ switch }}_toggle"
