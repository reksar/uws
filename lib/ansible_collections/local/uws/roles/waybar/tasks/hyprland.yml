# NOTE: Expected Hyprland to be running.

- name: "/!/ waybar package"
  package:
    name: "waybar"
  become: true
  register: waybar_status

# For the case when waybar installed on a non-fresh system.
- name: "Update waybar package deps"
  when: waybar_status.changed
  shell: "pacman --sync --refresh --noconfirm gcc gcc-libs"
  become: true

- name: "/?/ temperature CLI"
  stat:
    path: "/usr/local/bin/temperature"
  register: temperature_cli

- name: "/>/ waybar temperature script"
  when: temperature_cli.stat.exists
  template:
    src: "script/temperature.sh"
    dest: "{{ config_dir }}/script/"
    mode: "u=rwx,g=rx,o=rx"
  register: temperature_script_status

- name: "/>/ waybar config"
  vars:
    temperature: >-
      {{
        temperature_cli.stat.exists
        | ternary('custom/temperature', 'temperature')
      }}
    temperature_module: >-
      {{
        lookup(
          'template',
          'module/'
            + temperature_cli.stat.exists
              | ternary('temperature', 'temperature_default')
            + '.jsonc',
          variable_start_string="<<",
          variable_end_string=">>",
        )
      }}
  template:
    src: "hyprland.{{ config_name }}"
    dest: "{{ config_dir }}/{{ config_name }}"
    variable_start_string: "<<"
    variable_end_string: ">>"
  register: config_status

- name: "/>/ waybar style"
  copy:
    src: "hyprland.{{ style_name }}"
    dest: "{{ config_dir }}/{{ style_name }}"
  register: style_status

- debug:
    msg: "Handle waybar status"
  changed_when: >
    waybar_status.changed
      or config_status.changed
      or style_status.changed
      or temperature_script_status.changed
  notify: "Restart waybar"

- name: "/*/ Add waybar to Hyprland"
  vars:
    cfg: "{{ config_dir }}/{{ config_name }}"
    css: "{{ config_dir }}/{{ style_name}}"
  lineinfile:
    path: "{{ XDG_CONFIG_HOME }}/hypr/hyprland.conf"
    regexp: "exec-once\\s*=\\s*waybar"
    line: "exec-once = waybar -c '{{ cfg }}' -s '{{ css }}'"
